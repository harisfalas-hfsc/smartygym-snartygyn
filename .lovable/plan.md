

# Fix Superset Labels (A1, B1, C1...) -- Permanent Solution

## Root Cause

The "Leg Day Power Builder" workout has superset labels like `<strong>A1:</strong>` embedded in the database HTML. The existing label-stripping regex in the backend only catches **plain text** labels before exercise markup (e.g., `A1: {{exercise:...}}`), but fails when the label is wrapped in HTML tags like `<strong>A1:</strong>`.

This is why the labels keep appearing despite previous fixes -- the stripping logic has a blind spot for HTML-wrapped labels.

## Fix Strategy (Two Layers)

### 1. Fix the Existing Workout Data (Immediate)

Update the `main_workout` field of "Leg Day Power Builder" (ID: `WOD-S-E-1771367407134`) directly in the database to remove all `<strong>A1:</strong>`, `<strong>B1:</strong>`, etc. labels from the HTML content.

### 2. Add Frontend-Level Label Stripping (Permanent Safety Net)

Edit `src/components/ExerciseHTMLContent.tsx` to strip superset/sequence labels from the processed HTML before rendering. This catches any label pattern regardless of how it's wrapped in HTML:

- Strip patterns like `<strong>A1:</strong>`, `<strong>B:</strong>`, `<b>C2.</b>` (bold-wrapped labels)
- Strip plain-text labels like `A1:`, `B.`, `C)` that appear before exercise placeholders
- Applied only when `enableExerciseLinking` is true (workout content sections)

This ensures that even if the AI generates content with superset labels in the future, they will never display to users.

### 3. Strengthen Backend Stripping (Belt and Suspenders)

Update the post-processing regex in `supabase/functions/_shared/exercise-matching.ts` to also handle HTML-wrapped labels (e.g., `<strong>A1:</strong>`) so that future content processed through the backend pipeline is also cleaned.

## Technical Details

### File: `src/components/ExerciseHTMLContent.tsx`
- After sanitization and before rendering, add regex to strip:
  - `<strong>` or `<b>` wrapped single-letter + optional digit + punctuation patterns
  - Plain text single-letter labels at the start of list items
- Regex: `/<(?:strong|b)>[A-Za-z]\d*[\.\:\)]\s*<\/(?:strong|b)>\s*/g`

### File: `supabase/functions/_shared/exercise-matching.ts`
- Enhance the existing superset-stripping regex (around line 607) to also match HTML-tag-wrapped labels before exercise markup

### Database: Direct content fix
- Run an UPDATE on the specific workout to clean the `main_workout` field, removing all bold-wrapped superset labels

## What This Prevents
- Labels appearing in any workout, whether generated by AI or manually created
- Both frontend and backend now independently strip these labels
- No label pattern (plain text, bold, italic) will ever reach the user's screen again

